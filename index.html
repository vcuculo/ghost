<html>
  
  <head>
    <title>gHost - unHosted Photo Album using WebRTC</title>
    <link href="vendor/jquery.fancybox.css?v=2.1.4" rel="stylesheet"  type="text/css" media="screen" />
    <link href="vendor/buttons.css" rel="stylesheet" />
    <link href="css/ghost.css" rel="stylesheet" />
    <link href='https://fonts.googleapis.com/css?family=Metal+Mania&text=gHost%20unHosted%20Photo%20Album' rel='stylesheet' type='text/css'>
    <script src="vendor/remoteStorage.min.js"></script>
    <script src="vendor/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script src="vendor/jquery.fancybox.pack.js?v=2.1.4" type="text/javascript" ></script>
    <script src="js/pictures.js" type="text/javascript"></script>
    <script src="js/main.js"></script>
  </head>
  
  <body>
    <div id="remotestorage-connect"></div>
    <center>
      <div id="splash">
        <img src="images/logo.png"> <span class="title">gHost</span>
        <span class="subtitle">unHosted Photo Album</span>

      </div>
      <div id="info">
        <p><b>gHost</b> is an experimental web application
          <br>based on HTML5, CSS3 and JavaScript.</p>
        <p><b>gHost</b> uses
          <a href="http://jquery.com/" target="_blank">JQuery</a> and two new great technologies called
          <br>
          <a href="http://www.webrtc.org/" target="_blank">WebRTC</a> and
          <a href="http://remotestoragejs.com/" target="_blank">RemoteStorageJS</a>, used respectively
          <br>to capture the webcam stream without plugins and
          <br>to host the pictures taken, leaving users in control of their data.</p>
        <p><b>gHost</b> is hosted on
          <a href="https://github.com/vcuculo/ghost-unhosted-webrtc" target="_blank">GitHub</a>
        </p>
        <p style="font: 15px 'Courier New'">/* Author: Vittorio Cuculo */</p>
        <br>
        <br>
      </div>
      <div id="camerabox" style="display:none">
        <video id="camFeed" width="320" height="240" autoplay></video>
        <button class="blue-pill" id="takePhoto" style="display: none">Take Photo</button>
        <button class="blue-pill" id="savePhoto" style="display: none">Save Photo</button>
      </div>
      <img id="spinner" src="images/ajax-loader.gif" style="display:none">
    </center>
    <div id="album" style="z-index:1"></div>
    <script type="text/javascript">
    
    /* remotestorage init */
    
    $(document).ready(function() {
      remoteStorage.claimAccess({
        ghost: 'rw'
      }).then(function () {
        remoteStorage.displayWidget('remotestorage-connect');
        remoteStorage.ghost.dontSync();
        remoteStorage.onWidget('ready', showApp);
        remoteStorage.onWidget('disconnect', hideApp);
      });
    });

    /* buttons to take and save pictures from webcam */ 

    $('#takePhoto').on('click', function () {
      $('#camerabox').append('<canvas id="photo" width="320" height="240"></canvas>');

      $('#photo').css({
        'margin-top': '20px',
        'margin-bottom': '10px',
        'box-shadow': '0 0 50px 10px #fff'
      });

      var c = document.getElementById('photo');
      var v = document.getElementById('camFeed');
      c.getContext('2d').drawImage(v, 0, 0, 320, 240);

      $("html, body").animate({
        scrollTop: $(document).height()
      }, "slow");

      $('#savePhoto').show();

      return false;
    });

    $('#savePhoto').on('click', function () {
      var c = document.getElementById('photo');
      var type = "image/jpeg";
      var value = c.toDataURL(type); // base64encoded picture
      var ab = dataURItoArrayBuffer(value); // arraybuffer picture
      var uuid = remoteStorage.ghost.getUuid().substring(5);
      var filename = 'test-' + uuid + ".jpg";
      $('#photo').fadeOut('slow', function () {
        $('#photo').remove();
      });
      $('#savePhoto').hide();
      $('#album').append('<span id="imagespinner" width="160" height="120"><img src="images/ajax-loader.gif"></span>');
      remoteStorage.ghost.setPic(filename, type, ab).then(function (url) {
        $('#imagespinner').remove();
        $('#album').append('<a class="fancybox" href="' + url + '" rel="gHost" title="<a href=' + url + ' download=' + filename + ' title=\'Download this picture!\'>Download</a>"><img src="' + url + '"  width="160" height="120" title="' + filename + '"></img></a>').fadeIn('slow');
        return false;
      });
    });
    </script>
 </body>
</html>
